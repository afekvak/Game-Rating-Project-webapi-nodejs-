<!DOCTYPE html>
<html lang="he">

<!-- âœ… Include the head section -->
<%- include('partials/head') %>

<body>
    <!-- âœ… Include the navigation bar -->
    <%- include('partials/navbar') %>

    <!-- âœ… Main game details container -->
    <div class="game-container">

        <!-- âœ… Back button: Returns to either Home or Explore page -->
        <a href="<%= referer === 'home' ? '/' : '/games/explore' %>" class="back-btn">â¬… Back</a>

        <% if (!game) { %>
            <!-- âœ… If game data is missing, show an error message -->
            <h2>âš ï¸ Game not found</h2>
            <p>We couldn't retrieve the game details. Please try again later.</p>
        <% } else { %>
        
            <!-- âœ… Display game title -->
            <h1 class="game-title"><%= game.name %></h1>

            <!-- âœ… Game Image -->
            <div class="game-image-container">
                <img src="<%= game.image %>" alt="<%= game.name %>" class="game-image">
            </div>

            <!-- âœ… Game description and details -->
            <div class="game-description">
                <p><strong>ğŸ® Genre:</strong> <%= game.genre %></p>
                <p><strong>â­ Average Rating:</strong> <%= averageRating.toFixed(1) %></p>

                <p><%= game.description %></p>
            </div>

            <% if (game.trailer) { %>
                <!-- âœ… Game Trailer -->
                <div class="game-video">
                    <h2>ğŸ¥ Trailer</h2>
                    <iframe width="100%" height="315" src="<%= game.trailer %>" frameborder="0" allowfullscreen></iframe>
                </div>
            <% } else { %>
                <!-- âœ… If no trailer is available, display a message -->
                <div class="game-video">
                    <h2>ğŸ¥ No Trailer Available</h2>
                </div>
            <% } %>

            <% if (game.gameplay) { %>
                <!-- âœ… Gameplay Video -->
                <div class="game-video">
                    <h2>ğŸ® Gameplay</h2>
                    <iframe width="100%" height="315" src="<%= game.gameplay %>" frameborder="0" allowfullscreen></iframe>
                </div>
            <% } else { %>
                <!-- âœ… If no gameplay video is available, display a message -->
                <div class="game-video">
                    <h2>ğŸ® No Gameplay Video Available</h2>
                </div>
            <% } %>

            <!-- âœ… Game Rating Section -->
            <div class="game-rating">
                <form id="ratingForm">
                    <label for="rating">ğŸŒŸ Rate the game:</label>
                    <select id="rating" name="rating">
                        <option value="1">â­</option>
                        <option value="2">â­â­</option>
                        <option value="3">â­â­â­</option>
                        <option value="4">â­â­â­â­</option>
                        <option value="5">â­â­â­â­â­</option>
                    </select>
                    <button type="submit" class="btn">ğŸ’¾ Save Rating</button>
                </form>
            </div>

            <!-- âœ… JavaScript to handle rating submission -->
            <script>
                document.getElementById("ratingForm").addEventListener("submit", async (e) => {
                    e.preventDefault(); // âœ… Prevent form from refreshing the page
                    const rating = document.getElementById("rating").value; // âœ… Get selected rating value
            
                    // âœ… Send rating data to the server
                    const response = await fetch("/ratings/submit", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ gameId: "<%= game.rawgId %>", rating }) // âœ… FIXED: use rawgId instead of game.id
                    });
            
                    const data = await response.json(); // âœ… Convert response to JSON
                    alert(data.message); // âœ… Show success or error message
                });
            </script>
            

            <% if (game.stores) { %>
                <!-- âœ… Button to check where to buy the game -->
                <p><a href="/games/<%= game.id %>/stores" class="btn btn-buy">ğŸ›’ Purchase Links</a></p>
            <% } %>
        <% } %>

    </div>

    <!-- âœ… Include the footer section -->
    <%- include('partials/footer') %>

</body>

</html>
